# PostgreSQL High Availability with Patroni + HAProxy
# Usage: docker compose -f docker-compose.ha.yml up -d

services:
  # etcd cluster for Patroni consensus
  etcd:
    image: quay.io/coreos/etcd:v3.5.9
    container_name: grc-etcd
    environment:
      ETCD_NAME: etcd0
      ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd:2379
      ETCD_LISTEN_PEER_URLS: http://0.0.0.0:2380
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd:2380
      ETCD_INITIAL_CLUSTER: etcd0=http://etcd:2380
      ETCD_INITIAL_CLUSTER_STATE: new
      ETCD_INITIAL_CLUSTER_TOKEN: grc-etcd-cluster
    networks:
      - grc-network
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Primary (Patroni managed)
  pg-primary:
    image: postgres:15-alpine
    container_name: grc-pg-primary
    environment:
      POSTGRES_USER: ${DB_USER:-shahin_admin}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-Shahin@GRC2026!}
      POSTGRES_DB: ${DB_NAME:-shahin_grc}
    command: |
      postgres
      -c wal_level=replica
      -c max_wal_senders=5
      -c max_replication_slots=5
      -c hot_standby=on
      -c archive_mode=on
      -c archive_command='cp %p /var/lib/postgresql/archive/%f'
    volumes:
      - pg_primary_data:/var/lib/postgresql/data
      - pg_archive:/var/lib/postgresql/archive
    networks:
      - grc-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-shahin_admin}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Replica (Streaming Replication)
  pg-replica:
    image: postgres:15-alpine
    container_name: grc-pg-replica
    environment:
      POSTGRES_USER: ${DB_USER:-shahin_admin}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-Shahin@GRC2026!}
      PGUSER: ${DB_USER:-shahin_admin}
      PGPASSWORD: ${DB_PASSWORD:-Shahin@GRC2026!}
    command: |
      bash -c "
      rm -rf /var/lib/postgresql/data/*
      until pg_basebackup -h pg-primary -D /var/lib/postgresql/data -U ${DB_USER:-shahin_admin} -vP -R; do
        echo 'Waiting for primary...'
        sleep 5
      done
      chmod 700 /var/lib/postgresql/data
      postgres
      "
    volumes:
      - pg_replica_data:/var/lib/postgresql/data
    depends_on:
      pg-primary:
        condition: service_healthy
    networks:
      - grc-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-shahin_admin}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # HAProxy for load balancing and automatic failover
  haproxy:
    image: haproxy:2.8-alpine
    container_name: grc-haproxy
    ports:
      - "5432:5432"   # Write (primary)
      - "5433:5433"   # Read (replica)
      - "8404:8404"   # Stats
    volumes:
      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    depends_on:
      - pg-primary
      - pg-replica
    networks:
      - grc-network
    healthcheck:
      test: ["CMD", "haproxy", "-c", "-f", "/usr/local/etc/haproxy/haproxy.cfg"]
      interval: 30s
      timeout: 10s
      retries: 3

  # PgBouncer for connection pooling
  pgbouncer:
    image: edoburu/pgbouncer:latest
    container_name: grc-pgbouncer
    environment:
      DATABASE_URL: postgres://${DB_USER:-shahin_admin}:${DB_PASSWORD:-Shahin@GRC2026!}@haproxy:5432/${DB_NAME:-shahin_grc}
      POOL_MODE: transaction
      MAX_CLIENT_CONN: 1000
      DEFAULT_POOL_SIZE: 50
    ports:
      - "6432:5432"
    depends_on:
      - haproxy
    networks:
      - grc-network

  # Redis with Sentinel for HA
  redis-master:
    image: redis:7-alpine
    container_name: grc-redis-master
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-}
    volumes:
      - redis_master_data:/data
    networks:
      - grc-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis-replica:
    image: redis:7-alpine
    container_name: grc-redis-replica
    command: redis-server --appendonly yes --replicaof redis-master 6379 --requirepass ${REDIS_PASSWORD:-}
    depends_on:
      - redis-master
    volumes:
      - redis_replica_data:/data
    networks:
      - grc-network

volumes:
  pg_primary_data:
  pg_replica_data:
  pg_archive:
  redis_master_data:
  redis_replica_data:

networks:
  grc-network:
    external: true

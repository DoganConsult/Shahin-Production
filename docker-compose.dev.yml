# ═══════════════════════════════════════════════════════════════════════════════
# SHAHIN AI GRC PLATFORM - FULL STACK CONTAINERIZED DEVELOPMENT
# Docker Compose with all services including App, Analytics & Monitoring
# Created: 2026-01-21
# ═══════════════════════════════════════════════════════════════════════════════

services:
  # ═══════════════════════════════════════════════════════════════════════════════
  # APPLICATION SERVICES
  # ═══════════════════════════════════════════════════════════════════════════════

  grcmvc:
    build:
      context: ./src/GrcMvc
      dockerfile: Dockerfile
    container_name: grc-app
    restart: unless-stopped
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
      # Database
      ConnectionStrings__DefaultConnection: Host=db;Database=GrcMvcDb;Username=${DB_USER:-shahin_admin};Password=${DB_PASSWORD:-Shahin@GRC2026!};Port=5432
      ConnectionStrings__GrcAuthDb: Host=db;Database=GrcMvcDb;Username=${DB_USER:-shahin_admin};Password=${DB_PASSWORD:-Shahin@GRC2026!};Port=5432
      ConnectionStrings__HangfireConnection: Host=db;Database=GrcMvcDb;Username=${DB_USER:-shahin_admin};Password=${DB_PASSWORD:-Shahin@GRC2026!};Port=5432
      ConnectionStrings__Redis: redis:6379
      # JWT Settings
      JwtSettings__Secret: ${JWT_SECRET:-shahin-ai-grc-jwt-secret-key-minimum-32-characters-long-2026}
      JwtSettings__Issuer: http://localhost:5010
      JwtSettings__Audience: http://localhost:5010
      JwtSettings__ExpirationInMinutes: 60
      # OpenIddict
      AuthServer__Authority: http://localhost:5010/
      AuthServer__RequireHttpsMetadata: "false"
      # App URLs
      App__SelfUrl: http://localhost:5010
      App__ClientUrl: http://localhost:5010
      App__CorsOrigins: http://localhost:5010,http://localhost:3000,http://localhost:3003
      # Claude AI
      ClaudeAgents__Enabled: ${CLAUDE_ENABLED:-true}
      CLAUDE_API_KEY: ${CLAUDE_API_KEY:-}
      CLAUDE_MODEL: ${CLAUDE_MODEL:-claude-sonnet-4-20250514}
      # Hangfire
      HANGFIRE_DASHBOARD_ENABLED: "true"
      # Feature Flags
      Features__OnboardingEnabled: "true"
      Features__AIAgentsEnabled: "true"
      Features__AnalyticsEnabled: "true"
      Features__MultiTenancyEnabled: "true"
      MultiTenancy__IsEnabled: "true"
      # Security
      ALLOWED_HOSTS: "*"
      Security__AllowPublicRegistration: "true"
      # Logging
      Serilog__MinimumLevel: Information
    ports:
      - "${APP_PORT:-5010}:80"
    volumes:
      - grcmvc_data:/app/data
      - grcmvc_logs:/app/logs
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80/health/live || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    networks:
      - grc-network

  # Frontend Next.js Application
  frontend:
    build:
      context: ./grc-frontend
      dockerfile: Dockerfile
    container_name: grc-frontend
    restart: unless-stopped
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:5010
      NEXT_PUBLIC_OIDC_AUTHORITY: http://localhost:5010
      NEXT_PUBLIC_OIDC_CLIENT_ID: grc-web
      NEXT_PUBLIC_APP_NAME: Shahin GRC
      NEXTAUTH_URL: http://localhost:3003
      NEXTAUTH_SECRET: nextauth-secret-key-development-2026
    ports:
      - "${FRONTEND_PORT:-3003}:3000"
    depends_on:
      grcmvc:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - grc-network

  # ═══════════════════════════════════════════════════════════════════════════════
  # DATABASE SERVICES
  # ═══════════════════════════════════════════════════════════════════════════════

  db:
    image: postgres:15-alpine
    container_name: grc-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USER:-shahin_admin}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-Shahin@GRC2026!}
      POSTGRES_DB: ${DB_NAME:-GrcMvcDb}
      POSTGRES_MULTIPLE_DATABASES: GrcMvcDb,GrcAuthDb,metabase
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - grc_db_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-shahin_admin} -d ${DB_NAME:-GrcMvcDb}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - grc-network

  # ═══════════════════════════════════════════════════════════════════════════════
  # CACHING
  # ═══════════════════════════════════════════════════════════════════════════════

  redis:
    image: redis:7-alpine
    container_name: grc-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - grc-network

  # ═══════════════════════════════════════════════════════════════════════════════
  # KAFKA MESSAGING ECOSYSTEM
  # ═══════════════════════════════════════════════════════════════════════════════

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: grc-zookeeper
    restart: unless-stopped
    environment:
      ZOOKEEPER_CLIENT_PORT: ${ZOOKEEPER_PORT:-2181}
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "${ZOOKEEPER_PORT:-2181}:2181"
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data
      - zookeeper_logs:/var/lib/zookeeper/log
    healthcheck:
      test: ["CMD-SHELL", "echo ruok | nc localhost ${ZOOKEEPER_PORT:-2181} | grep imok"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - grc-network

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: grc-kafka
    restart: unless-stopped
    depends_on:
      zookeeper:
        condition: service_healthy
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:${ZOOKEEPER_PORT:-2181}
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:${KAFKA_PORT:-9092}
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    ports:
      - "${KAFKA_PORT:-9092}:9092"
      - "29092:29092"
    volumes:
      - kafka_data:/var/lib/kafka/data
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:${KAFKA_PORT:-9092}"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - grc-network

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: grc-kafka-ui
    restart: unless-stopped
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      KAFKA_CLUSTERS_0_NAME: grc-local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:${ZOOKEEPER_PORT:-2181}
    ports:
      - "${KAFKA_UI_PORT:-9080}:8080"
    networks:
      - grc-network

  # ═══════════════════════════════════════════════════════════════════════════════
  # WORKFLOW ENGINE - CAMUNDA BPM
  # ═══════════════════════════════════════════════════════════════════════════════

  camunda:
    image: camunda/camunda-bpm-platform:7.20.0
    container_name: grc-camunda
    restart: unless-stopped
    environment:
      DB_DRIVER: org.h2.Driver
      DB_URL: jdbc:h2:./camunda-h2-dbs/process-engine
      DB_USERNAME: ${CAMUNDA_USERNAME:-demo}
      DB_PASSWORD: ${CAMUNDA_PASSWORD:-demo}
    ports:
      - "${CAMUNDA_PORT:-8085}:8080"
    volumes:
      - camunda_data:/camunda/camunda-h2-dbs
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/camunda/app/welcome/default/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    networks:
      - grc-network

  # ═══════════════════════════════════════════════════════════════════════════════
  # ANALYTICS STACK - CLICKHOUSE OLAP DATABASE
  # ═══════════════════════════════════════════════════════════════════════════════

  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: grc-clickhouse
    restart: unless-stopped
    environment:
      CLICKHOUSE_DB: ${CLICKHOUSE_DB:-grc_analytics}
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-grc_analytics}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-grc_analytics_2026}
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    ports:
      - "${CLICKHOUSE_HTTP_PORT:-8123}:8123"
      - "${CLICKHOUSE_NATIVE_PORT:-9000}:9000"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./scripts/init-analytics-db.sql:/docker-entrypoint-initdb.d/init-analytics-db.sql:ro
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8123/ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - grc-network

  # ═══════════════════════════════════════════════════════════════════════════════
  # ANALYTICS STACK - GRAFANA MONITORING
  # ═══════════════════════════════════════════════════════════════════════════════

  grafana:
    image: grafana/grafana-oss:latest
    container_name: grc-grafana
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_USER: ${GF_SECURITY_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD:-GrafanaAdmin@2026!}
      GF_INSTALL_PLUGINS: ${GF_INSTALL_PLUGINS:-grafana-clickhouse-datasource}
      GF_SERVER_ROOT_URL: http://localhost:${GRAFANA_PORT:-3030}
      GF_USERS_ALLOW_SIGN_UP: "false"
    ports:
      - "${GRAFANA_PORT:-3030}:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
    depends_on:
      clickhouse:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - grc-network

  # ═══════════════════════════════════════════════════════════════════════════════
  # ANALYTICS STACK - APACHE SUPERSET BI
  # ═══════════════════════════════════════════════════════════════════════════════

  superset:
    image: apache/superset:latest
    container_name: grc-superset
    restart: unless-stopped
    environment:
      SUPERSET_SECRET_KEY: ${SUPERSET_SECRET_KEY:-superset-secret-key-development-2026}
      SUPERSET_ADMIN_USER: ${SUPERSET_ADMIN_USER:-admin}
      SUPERSET_ADMIN_PASSWORD: ${SUPERSET_ADMIN_PASSWORD:-SupersetAdmin@2026!}
      SUPERSET_ADMIN_EMAIL: ${SUPERSET_ADMIN_EMAIL:-admin@shahin-ai.com}
      DATABASE_URL: postgresql://${DB_USER:-shahin_admin}:${DB_PASSWORD:-Shahin@GRC2026!}@db:5432/superset
    ports:
      - "${SUPERSET_PORT:-8088}:8088"
    volumes:
      - superset_home:/app/superset_home
    depends_on:
      db:
        condition: service_healthy
    command: >
      bash -c "
        superset db upgrade &&
        superset fab create-admin --username ${SUPERSET_ADMIN_USER:-admin} --firstname Admin --lastname User --email ${SUPERSET_ADMIN_EMAIL:-admin@shahin-ai.com} --password ${SUPERSET_ADMIN_PASSWORD:-SupersetAdmin@2026!} || true &&
        superset init &&
        superset run -h 0.0.0.0 -p 8088 --with-threads --reload --debugger
      "
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8088/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    networks:
      - grc-network

  # ═══════════════════════════════════════════════════════════════════════════════
  # ANALYTICS STACK - METABASE
  # ═══════════════════════════════════════════════════════════════════════════════

  metabase:
    image: metabase/metabase:latest
    container_name: grc-metabase
    restart: unless-stopped
    environment:
      MB_DB_TYPE: ${MB_DB_TYPE:-postgres}
      MB_DB_DBNAME: metabase
      MB_DB_PORT: 5432
      MB_DB_USER: ${MB_DB_USER:-shahin_admin}
      MB_DB_PASS: ${MB_DB_PASS:-Shahin@GRC2026!}
      MB_DB_HOST: db
      JAVA_TIMEZONE: UTC
    ports:
      - "${METABASE_PORT:-3033}:3000"
    volumes:
      - metabase_data:/metabase-data
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - grc-network

  # ═══════════════════════════════════════════════════════════════════════════════
  # WORKFLOW AUTOMATION - N8N
  # ═══════════════════════════════════════════════════════════════════════════════

  n8n:
    image: n8nio/n8n:latest
    container_name: grc-n8n
    restart: unless-stopped
    environment:
      N8N_BASIC_AUTH_ACTIVE: ${N8N_BASIC_AUTH_ACTIVE:-true}
      N8N_BASIC_AUTH_USER: ${N8N_BASIC_AUTH_USER:-admin}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_BASIC_AUTH_PASSWORD:-N8nAdmin@2026!}
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY:-n8n-encryption-key-development}
      WEBHOOK_URL: http://localhost:${N8N_PORT:-5678}
      GENERIC_TIMEZONE: UTC
    ports:
      - "${N8N_PORT:-5678}:5678"
    volumes:
      - n8n_data:/home/node/.n8n
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5678/healthz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - grc-network

# ═══════════════════════════════════════════════════════════════════════════════
# VOLUMES
# ═══════════════════════════════════════════════════════════════════════════════

volumes:
  grcmvc_data:
    driver: local
  grcmvc_logs:
    driver: local
  grc_db_data:
    driver: local
  redis_data:
    driver: local
  zookeeper_data:
    driver: local
  zookeeper_logs:
    driver: local
  kafka_data:
    driver: local
  camunda_data:
    driver: local
  clickhouse_data:
    driver: local
  grafana_data:
    driver: local
  superset_home:
    driver: local
  metabase_data:
    driver: local
  n8n_data:
    driver: local

# ═══════════════════════════════════════════════════════════════════════════════
# NETWORKS
# ═══════════════════════════════════════════════════════════════════════════════

networks:
  grc-network:
    driver: bridge
    name: grc-network

@using GrcMvc.Application.Policy
@using GrcMvc.Application.Permissions
@using Microsoft.AspNetCore.Components
@inherits ComponentBase

@if (Violation != null)
{
    <div class="alert alert-@GetSeverityClass() alert-dismissible fade show" role="alert">
        <div class="d-flex align-items-start">
            <i class="fas fa-@GetSeverityIcon() me-2 mt-1"></i>
            <div class="flex-grow-1">
                <h5 class="alert-heading mb-2">@GetSeverityTitle()</h5>
                <p class="mb-2">@Violation.Message</p>
                
                @if (!string.IsNullOrEmpty(Violation.RemediationHint))
                {
                    <div class="mt-3">
                        <strong>ðŸ’¡ How to fix:</strong>
                        <p class="mb-0">@Violation.RemediationHint</p>
                    </div>
                }

                @if (Violation.FailedConditions?.Any() == true)
                {
                    <div class="mt-3">
                        <strong>Issues found:</strong>
                        <ul class="mb-0 mt-2">
                            @foreach (var condition in Violation.FailedConditions)
                            {
                                <li>@condition</li>
                            }
                        </ul>
                    </div>
                }

                @if (CanAutoFix)
                {
                    <div class="mt-3">
                        <button class="btn btn-sm btn-primary" @onclick="HandleAutoFix">
                            <i class="fas fa-magic me-1"></i> Auto-fix this issue
                        </button>
                    </div>
                }
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
}

@code {
    [Parameter] public PolicyViolationInfo? Violation { get; set; }
    [Parameter] public bool CanAutoFix { get; set; }
    [Parameter] public EventCallback OnAutoFix { get; set; }
    [Inject] protected IHttpContextAccessor HttpContextAccessor { get; set; } = null!;

    private string GetSeverityClass()
    {
        return Violation?.Severity?.ToLower() switch
        {
            "critical" => "danger",
            "high" => "warning",
            "medium" => "warning",
            "low" => "info",
            _ => "warning"
        };
    }

    private string GetSeverityIcon()
    {
        return Violation?.Severity?.ToLower() switch
        {
            "critical" => "exclamation-triangle",
            "high" => "exclamation-circle",
            "medium" => "info-circle",
            "low" => "lightbulb",
            _ => "info-circle"
        };
    }

    private string GetSeverityTitle()
    {
        return Violation?.Severity?.ToLower() switch
        {
            "critical" => "âš ï¸ Policy Violation (Critical)",
            "high" => "âš ï¸ Policy Violation (High Priority)",
            "medium" => "â„¹ï¸ Policy Requirement",
            "low" => "ðŸ’¡ Policy Suggestion",
            _ => "Policy Violation"
        };
    }

    private async Task HandleAutoFix()
    {
        await OnAutoFix.InvokeAsync();
    }
}

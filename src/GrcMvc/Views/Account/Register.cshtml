@using Microsoft.AspNetCore.Mvc.Localization
@inject IHtmlLocalizer<SharedResource> L
@model GrcMvc.Models.ViewModels.RegisterViewModel
@{
    ViewData["Title"] = L["Auth_RegisterTitle"].Value;
    Layout = "_Layout";
}

<div class="auth-form">
    <div class="card">
        <div class="card-header text-center">
            <h4><i class="bi bi-person-plus"></i> @L["Auth_CreateNewAccount"]</h4>
        </div>
        <div class="card-body">
            <form asp-action="Register" method="post">
                <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="FirstName" class="form-label"></label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-person"></i></span>
                            <input asp-for="FirstName" class="form-control" placeholder="@L["Auth_FirstNamePlaceholder"]" />
                        </div>
                        <span asp-validation-for="FirstName" class="text-danger"></span>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label asp-for="LastName" class="form-label"></label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-person"></i></span>
                            <input asp-for="LastName" class="form-control" placeholder="@L["Auth_LastNamePlaceholder"]" />
                        </div>
                        <span asp-validation-for="LastName" class="text-danger"></span>
                    </div>
                </div>

                <div class="mb-3">
                    <label asp-for="Email" class="form-label"></label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                        <input asp-for="Email" class="form-control" placeholder="@L["Auth_EmailPlaceholder"]" />
                    </div>
                    <span asp-validation-for="Email" class="text-danger"></span>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="Department" class="form-label">@L["Auth_Department"]</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-building"></i></span>
                            <select asp-for="Department" class="form-select" id="departmentSelect">
                                <option value="">-- @L["Auth_SelectDepartment"] --</option>
                                <option value="IT">@L["Dept_IT"]</option>
                                <option value="Compliance">@L["Dept_Compliance"]</option>
                                <option value="RiskManagement">@L["Dept_RiskManagement"]</option>
                                <option value="InternalAudit">@L["Dept_InternalAudit"]</option>
                                <option value="Legal">@L["Dept_Legal"]</option>
                                <option value="Finance">@L["Dept_Finance"]</option>
                                <option value="HR">@L["Dept_HR"]</option>
                                <option value="Operations">@L["Dept_Operations"]</option>
                                <option value="Security">@L["Dept_Security"]</option>
                                <option value="Management">@L["Dept_Management"]</option>
                            </select>
                        </div>
                        <span asp-validation-for="Department" class="text-danger"></span>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label asp-for="JobTitle" class="form-label">@L["Auth_JobTitle"]</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-briefcase"></i></span>
                            <select class="form-select" id="jobTitleSelect">
                                <option value="">-- @L["Auth_SelectJobTitle"] --</option>
                            </select>
                        </div>
                        <!-- Role description tooltip -->
                        <small id="roleDescription" class="form-text text-info" style="display: none;"></small>
                        <!-- Custom job title input (shown when "Other" is selected) -->
                        <div id="customJobTitleDiv" class="mt-2" style="display: none;">
                            <input asp-for="JobTitle" class="form-control" id="customJobTitleInput"
                                   placeholder="@L["Auth_EnterCustomJobTitle"]" />
                        </div>
                        <input type="hidden" asp-for="JobTitle" id="finalJobTitle" />
                        <span asp-validation-for="JobTitle" class="text-danger"></span>
                    </div>
                </div>

                <div class="mb-3">
                    <label asp-for="Password" class="form-label"></label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-lock"></i></span>
                        <input asp-for="Password" class="form-control" placeholder="@L["Auth_PasswordCreatePlaceholder"]" />
                    </div>
                    <span asp-validation-for="Password" class="text-danger"></span>
                    <small class="form-text text-muted">
                        @L["Auth_PasswordRequirements"]
                    </small>
                </div>

                <div class="mb-3">
                    <label asp-for="ConfirmPassword" class="form-label"></label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
                        <input asp-for="ConfirmPassword" class="form-control" placeholder="@L["Auth_ConfirmPasswordPlaceholder"]" />
                    </div>
                    <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                </div>

                <div class="mb-3 form-check">
                    <input asp-for="AcceptTerms" class="form-check-input" type="checkbox" />
                    <label asp-for="AcceptTerms" class="form-check-label">
                        @L["Auth_AcceptTerms"] <a href="/terms" target="_blank">@L["Auth_TermsAndConditions"]</a>
                    </label>
                    <span asp-validation-for="AcceptTerms" class="text-danger d-block"></span>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-person-plus"></i> @L["Nav_Register"]
                    </button>
                </div>

                <hr />

                <div class="text-center">
                    <p>
                        @L["Auth_AlreadyHaveAccount"] <a asp-action="Login" asp-route-returnUrl="@ViewData["ReturnUrl"]">@L["Auth_LoginHere"]</a>
                    </p>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script nonce="@ViewData["CSPNonce"]">
        // Job titles mapped to departments based on GRC Role Profiles
        const jobTitlesByDepartment = {
            'IT': [
                { value: 'SecurityManager', text: '@L["Role_SecurityManager"]' },
                { value: 'RiskAnalyst', text: '@L["Role_RiskAnalyst"]' },
                { value: 'ComplianceOfficer', text: '@L["Role_ComplianceOfficer"]' },
                { value: 'ProcessOwner', text: '@L["Role_ProcessOwner"]' }
            ],
            'Compliance': [
                { value: 'ChiefComplianceOfficer', text: '@L["Role_CCO"]' },
                { value: 'ComplianceManager', text: '@L["Role_ComplianceManager"]' },
                { value: 'ComplianceOfficer', text: '@L["Role_ComplianceOfficer"]' },
                { value: 'DocumentationSpecialist', text: '@L["Role_DocumentationSpecialist"]' }
            ],
            'RiskManagement': [
                { value: 'ChiefRiskOfficer', text: '@L["Role_CRO"]' },
                { value: 'RiskManager', text: '@L["Role_RiskManager"]' },
                { value: 'RiskAnalyst', text: '@L["Role_RiskAnalyst"]' }
            ],
            'InternalAudit': [
                { value: 'AuditManager', text: '@L["Role_AuditManager"]' },
                { value: 'QualityAssuranceManager', text: '@L["Role_QAManager"]' },
                { value: 'ReportingAnalyst', text: '@L["Role_ReportingAnalyst"]' }
            ],
            'Legal': [
                { value: 'LegalManager', text: '@L["Role_LegalManager"]' },
                { value: 'PrivacyOfficer', text: '@L["Role_PrivacyOfficer"]' }
            ],
            'Finance': [
                { value: 'FinanceManager', text: '@L["Role_FinanceManager"]' },
                { value: 'ReportingAnalyst', text: '@L["Role_ReportingAnalyst"]' }
            ],
            'HR': [
                { value: 'HRManager', text: '@L["Role_HRManager"]' },
                { value: 'ProcessOwner', text: '@L["Role_ProcessOwner"]' }
            ],
            'Operations': [
                { value: 'OperationalManager', text: '@L["Role_OperationalManager"]' },
                { value: 'ProcessOwner', text: '@L["Role_ProcessOwner"]' }
            ],
            'Security': [
                { value: 'SecurityManager', text: '@L["Role_SecurityManager"]' },
                { value: 'PrivacyOfficer', text: '@L["Role_PrivacyOfficer"]' },
                { value: 'RiskAnalyst', text: '@L["Role_RiskAnalyst"]' }
            ],
            'Management': [
                { value: 'TenantAdmin', text: '@L["Role_TenantAdmin"]' },
                { value: 'ExecutiveDirector', text: '@L["Role_ExecutiveDirector"]' },
                { value: 'ChiefRiskOfficer', text: '@L["Role_CRO"]' },
                { value: 'ChiefComplianceOfficer', text: '@L["Role_CCO"]' },
                { value: 'BoardMember', text: '@L["Role_BoardMember"]' }
            ]
        };

        // Role descriptions for tooltips
        const roleDescriptions = {
            'TenantAdmin': '@L["RoleDesc_TenantAdmin"]',
            'ExecutiveDirector': '@L["RoleDesc_ExecutiveDirector"]',
            'ChiefRiskOfficer': '@L["RoleDesc_CRO"]',
            'ChiefComplianceOfficer': '@L["RoleDesc_CCO"]',
            'RiskManager': '@L["RoleDesc_RiskManager"]',
            'ComplianceManager': '@L["RoleDesc_ComplianceManager"]',
            'AuditManager': '@L["RoleDesc_AuditManager"]',
            'SecurityManager': '@L["RoleDesc_SecurityManager"]',
            'BoardMember': '@L["RoleDesc_BoardMember"]'
        };

        $(document).ready(function() {
            const deptSelect = $('#departmentSelect');
            const jobSelect = $('#jobTitleSelect');
            const roleDesc = $('#roleDescription');
            const customDiv = $('#customJobTitleDiv');
            const customInput = $('#customJobTitleInput');
            const finalJobTitle = $('#finalJobTitle');
            const defaultOption = '<option value="">-- @L["Auth_SelectJobTitle"] --</option>';
            const otherOption = '<option value="__OTHER__">@L["Role_Other"]</option>';

            // Update job titles when department changes
            deptSelect.change(function() {
                const dept = $(this).val();
                jobSelect.html(defaultOption);
                customDiv.hide();
                customInput.val('');
                finalJobTitle.val('');
                roleDesc.hide().text('');

                if (dept && jobTitlesByDepartment[dept]) {
                    jobTitlesByDepartment[dept].forEach(function(job) {
                        jobSelect.append($('<option>', {
                            value: job.value,
                            text: job.text
                        }));
                    });
                    // Add "Other" option at the end
                    jobSelect.append(otherOption);
                }
            });

            // Handle job title selection
            jobSelect.change(function() {
                const selectedValue = $(this).val();
                if (selectedValue === '__OTHER__') {
                    customDiv.show();
                    customInput.focus();
                    finalJobTitle.val('');
                    roleDesc.hide();
                } else {
                    customDiv.hide();
                    customInput.val('');
                    finalJobTitle.val(selectedValue);

                    // Show role description if available
                    if (selectedValue && roleDescriptions[selectedValue]) {
                        roleDesc.text(roleDescriptions[selectedValue]).show();
                    } else {
                        roleDesc.hide();
                    }
                }
            });

            // Sync custom input to hidden field
            customInput.on('input', function() {
                finalJobTitle.val($(this).val());
            });

            // Before form submit, ensure value is set
            $('form').on('submit', function() {
                if (jobSelect.val() === '__OTHER__') {
                    finalJobTitle.val(customInput.val());
                } else {
                    finalJobTitle.val(jobSelect.val());
                }
            });

            // Trigger change on page load if department is pre-selected
            if (deptSelect.val()) {
                deptSelect.trigger('change');
            }
        });
    </script>
}
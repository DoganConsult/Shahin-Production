@model OrganizationProfileDto

@{
    ViewData["Title"] = Localizer["OrgProfile_Title"];
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid mt-4 mb-5">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <!-- Progress Indicator -->
            <div class="card mb-4 border-0 bg-light">
                <div class="card-body">
                    <h5 class="card-title mb-3">@Localizer["Onboarding_Progress"]</h5>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 50%;" aria-valuenow="50"
                            aria-valuemin="0" aria-valuemax="100">
                            Step 2: Organization Profile
                        </div>
                    </div>
                    <small class="text-muted mt-2 d-block">
                        Step 1: Registration ✓ → Step 2: Organization Profile → Step 3: Review Scope → Step 4: Create
                        Plan
                    </small>
                </div>
            </div>

            <!-- Organization Profile Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-building"></i> @Localizer["OrgProfile_Header"]
                    </h4>
                </div>

                <div class="card-body p-4">
                    <form asp-action="SaveOrgProfile" asp-controller="Onboarding" method="post" id="profileForm"
                        novalidate>
                        <div asp-validation-summary="All" class="alert alert-danger" role="alert"></div>

                        <input type="hidden" asp-for="TenantId" />

                        <!-- Basic Information -->
                        <h5 class="mb-3 text-primary border-bottom pb-2">
                            <i class="fas fa-info-circle"></i> @Localizer["OrgProfile_BasicInfo"]
                        </h5>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="OrganizationType" class="form-label">
                                    <span class="text-danger">*</span> Organization Type
                                </label>
                                <select asp-for="OrganizationType" class="form-select" id="OrganizationType">
                                    <option value="">-- Loading... --</option>
                                </select>
                                <span asp-validation-for="OrganizationType" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="Sector" class="form-label">
                                    <span class="text-danger">*</span> Sector
                                </label>
                                <select asp-for="Sector" class="form-select" id="Sector">
                                    <option value="">-- Loading... --</option>
                                </select>
                                <span asp-validation-for="Sector" class="text-danger small"></span>
                                <small class="text-muted d-block mt-1" id="sectorRegulator"></small>
                            </div>
                        </div>

                        <!-- Geographic & Operational -->
                        <h5 class="mb-3 mt-4 text-primary border-bottom pb-2">
                            <i class="fas fa-globe"></i> @Localizer["OrgProfile_Geographic"]
                        </h5>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Country" class="form-label">
                                    <span class="text-danger">*</span> Primary Country
                                </label>
                                <select asp-for="Country" class="form-select" id="Country">
                                    <option value="">-- Loading... --</option>
                                </select>
                                <span asp-validation-for="Country" class="text-danger small"></span>
                                <small class="text-muted d-block mt-1" id="countryInfo"></small>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="HostingModel" class="form-label">
                                    <span class="text-danger">*</span> Data Hosting Model
                                </label>
                                <select asp-for="HostingModel" class="form-select" id="HostingModel">
                                    <option value="">-- Loading... --</option>
                                </select>
                                <span asp-validation-for="HostingModel" class="text-danger small"></span>
                            </div>
                        </div>

                        <!-- Data & Security -->
                        <h5 class="mb-3 mt-4 text-primary border-bottom pb-2">
                            <i class="fas fa-shield-alt"></i> Data & Security
                        </h5>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="DataTypes" class="form-label">
                                    <span class="text-danger">*</span> Data Types Processed
                                </label>
                                <select asp-for="DataTypes" class="form-select" multiple size="5" id="DataTypes">
                                    <option value="">-- Loading... --</option>
                                </select>
                                <span asp-validation-for="DataTypes" class="text-danger small"></span>
                                <small class="text-muted d-block mt-1">Hold Ctrl/Cmd to select multiple.</small>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="Size" class="form-label">
                                    <span class="text-danger">*</span> Organization Size
                                </label>
                                <select asp-for="Size" class="form-select" id="Size">
                                    <option value="">-- Loading... --</option>
                                </select>
                                <span asp-validation-for="Size" class="text-danger small"></span>
                                <small class="text-muted d-block mt-1" id="sizeInfo"></small>
                            </div>
                        </div>

                        <!-- Maturity & Compliance -->
                        <h5 class="mb-3 mt-4 text-primary border-bottom pb-2">
                            <i class="fas fa-chart-line"></i> Maturity & Compliance
                        </h5>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Maturity" class="form-label">
                                    <span class="text-danger">*</span> Compliance Maturity Level
                                </label>
                                <select asp-for="Maturity" class="form-select" id="Maturity">
                                    <option value="">-- Loading... --</option>
                                </select>
                                <span asp-validation-for="Maturity" class="text-danger small"></span>
                                <small class="text-muted d-block mt-1" id="maturityInfo"></small>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <span class="text-danger">*</span> Is Critical Infrastructure?
                                </label>
                                <div class="form-check mt-2">
                                    <input type="hidden" name="IsCriticalInfrastructure" value="false">
                                    <input class="form-check-input" type="checkbox" id="isCritical"
                                        name="IsCriticalInfrastructure" value="true">
                                    <label class="form-check-label" for="isCritical">
                                        Yes, our organization is considered critical infrastructure
                                    </label>
                                </div>
                                <small class="text-muted d-block mt-1">Applies stricter regulatory requirements (NRA,
                                    MOI).</small>
                            </div>
                        </div>

                        <!-- Third-Party Services -->
                        <h5 class="mb-3 mt-4 text-primary border-bottom pb-2">
                            <i class="fas fa-handshake"></i> Third-Party Services
                        </h5>

                        <div class="mb-3">
                            <label asp-for="Vendors" class="form-label">
                                Key Third-Party Vendors / Services
                            </label>
                            <textarea asp-for="Vendors" class="form-control" rows="3"
                                placeholder="List major vendors (e.g., AWS, Azure, ServiceNow, Salesforce)"></textarea>
                            <small class="text-muted d-block mt-1">Comma-separated or one per line.</small>
                        </div>

                        <!-- Expert-Derived Frameworks (Auto-populated based on sector) -->
                        <div id="derivedFrameworksSection" class="mt-4" style="display: none;">
                            <h5 class="mb-3 text-success border-bottom pb-2">
                                <i class="fas fa-magic"></i> الأطر التنظيمية المطبقة تلقائياً | Auto-Derived Frameworks
                            </h5>
                            <div class="alert alert-info">
                                <i class="fas fa-robot me-2"></i>
                                <strong>Expert-Driven Mapping:</strong> Based on your sector selection, the following regulatory frameworks
                                will automatically apply to your organization. No manual selection needed!
                            </div>

                            <div id="frameworksList" class="row">
                                <!-- Frameworks will be populated dynamically -->
                            </div>

                            <div class="card bg-light mt-3" id="implementationGuidance" style="display: none;">
                                <div class="card-body">
                                    <h6><i class="fas fa-lightbulb text-warning"></i> Implementation Guidance</h6>
                                    <p id="guidanceText" class="mb-2 small"></p>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <strong>Estimated Timeline:</strong> <span id="estimatedMonths" class="badge bg-primary"></span>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Priority Focus:</strong> <span id="priorityFocus" class="text-muted small"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3" id="regulatoryDeadlines" style="display: none;">
                                <h6><i class="fas fa-calendar-alt text-danger"></i> Regulatory Deadlines</h6>
                                <ul id="deadlinesList" class="small mb-0"></ul>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-grid gap-2 d-sm-flex justify-content-between mt-4">
                            <a href="@Url.Action("Signup", "Onboarding")" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-arrow-right"></i> Continue to Review Scope
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Lookup data cache (loaded from API)
    let lookupData = {
        countries: [],
        sectors: [],
        organizationTypes: [],
        hostingModels: [],
        dataTypes: [],
        sizes: [],
        maturities: [],
        frameworks: []
    };

    // Load all lookup data on page load
    async function loadLookups() {
        try {
            const [countries, sectors, orgTypes, frameworks] = await Promise.all([
                fetch('/api/lookups/countries').then(r => r.json()),
                fetch('/api/lookups/sectors').then(r => r.json()),
                fetch('/api/lookups/organization-types').then(r => r.json()),
                fetch('/api/lookups/frameworks').then(r => r.json())
            ]);

            lookupData.countries = countries;
            lookupData.sectors = sectors;
            lookupData.organizationTypes = orgTypes;
            lookupData.frameworks = frameworks;

            // Populate dropdowns
            populateDropdown('Country', countries, 'code', 'nameEn', 'nameAr');
            populateDropdown('Sector', sectors, 'code', 'nameEn', 'nameAr');
            populateDropdown('OrganizationType', orgTypes, 'code', 'nameEn', 'nameAr');

            // Static lookups (not in DB yet - can be added later)
            populateStaticDropdowns();

            // Restore any previously selected values from model
            restoreSelectedValues();

        } catch (error) {
            console.error('Error loading lookups:', error);
            showError('Failed to load form options. Please refresh the page.');
        }
    }

    function populateDropdown(elementId, items, valueField, labelField, labelFieldAr) {
        const select = document.getElementById(elementId);
        if (!select) return;

        const currentValue = select.getAttribute('data-current-value') || '@Model?.Country' === '' ? '' : select.value;
        select.innerHTML = '<option value="">-- Select --</option>';

        items.forEach(item => {
            const option = document.createElement('option');
            option.value = item[valueField];
            // Show bilingual: English | Arabic
            const labelEn = item[labelField] || item.nameEn || item.name;
            const labelAr = item[labelFieldAr] || item.nameAr;
            option.textContent = labelAr ? `${labelEn} | ${labelAr}` : labelEn;
            if (item.isDefault) option.selected = true;
            select.appendChild(option);
        });
    }

    function populateStaticDropdowns() {
        // Hosting Models
        const hostingModels = [
            { code: 'OnPremise', nameEn: 'On-Premise', nameAr: 'محلي' },
            { code: 'Cloud', nameEn: 'Cloud (Public)', nameAr: 'سحابي عام' },
            { code: 'Hybrid', nameEn: 'Hybrid', nameAr: 'هجين' },
            { code: 'PrivateCloud', nameEn: 'Private Cloud', nameAr: 'سحابي خاص' },
            { code: 'SovereignCloud', nameEn: 'Sovereign Cloud (KSA)', nameAr: 'سحابي سيادي' }
        ];
        populateDropdown('HostingModel', hostingModels, 'code', 'nameEn', 'nameAr');

        // Data Types
        const dataTypes = [
            { code: 'Personal', nameEn: 'Personal Data', nameAr: 'بيانات شخصية' },
            { code: 'Financial', nameEn: 'Financial Data', nameAr: 'بيانات مالية' },
            { code: 'Health', nameEn: 'Health/Medical Data', nameAr: 'بيانات صحية' },
            { code: 'Government', nameEn: 'Government Classified', nameAr: 'بيانات حكومية سرية' },
            { code: 'Intellectual', nameEn: 'Intellectual Property', nameAr: 'ملكية فكرية' },
            { code: 'Customer', nameEn: 'Customer Data', nameAr: 'بيانات العملاء' },
            { code: 'Employee', nameEn: 'Employee Data', nameAr: 'بيانات الموظفين' }
        ];
        populateDropdown('DataTypes', dataTypes, 'code', 'nameEn', 'nameAr');

        // Organization Sizes
        const sizes = [
            { code: 'Micro', nameEn: 'Micro (1-10 employees)', nameAr: 'صغير جداً (1-10)' },
            { code: 'Small', nameEn: 'Small (11-50 employees)', nameAr: 'صغير (11-50)' },
            { code: 'Medium', nameEn: 'Medium (51-250 employees)', nameAr: 'متوسط (51-250)' },
            { code: 'Large', nameEn: 'Large (251-1000 employees)', nameAr: 'كبير (251-1000)' },
            { code: 'Enterprise', nameEn: 'Enterprise (1000+ employees)', nameAr: 'مؤسسة كبرى (1000+)' }
        ];
        populateDropdown('Size', sizes, 'code', 'nameEn', 'nameAr');

        // Maturity Levels
        const maturities = [
            { code: 'Initial', nameEn: 'Level 1: Initial (Ad-hoc)', nameAr: 'المستوى 1: أولي' },
            { code: 'Developing', nameEn: 'Level 2: Developing (Some policies)', nameAr: 'المستوى 2: نامي' },
            { code: 'Defined', nameEn: 'Level 3: Defined (Documented)', nameAr: 'المستوى 3: محدد' },
            { code: 'Managed', nameEn: 'Level 4: Managed (Measured)', nameAr: 'المستوى 4: مُدار' },
            { code: 'Optimizing', nameEn: 'Level 5: Optimizing (Continuous)', nameAr: 'المستوى 5: مُحسَّن' }
        ];
        populateDropdown('Maturity', maturities, 'code', 'nameEn', 'nameAr');
    }

    function restoreSelectedValues() {
        // Restore values from server-side model if editing
        const modelValues = {
            Country: '@(Model?.Country ?? "")',
            Sector: '@(Model?.Sector ?? "")',
            OrganizationType: '@(Model?.OrganizationType ?? "")',
            HostingModel: '@(Model?.HostingModel ?? "")',
            Size: '@(Model?.Size ?? "")',
            Maturity: '@(Model?.Maturity ?? "")'
        };

        Object.keys(modelValues).forEach(key => {
            if (modelValues[key]) {
                const select = document.getElementById(key);
                if (select) select.value = modelValues[key];
            }
        });

        // DataTypes is multi-select
        const dataTypesValue = '@(Model?.DataTypes ?? "")';
        if (dataTypesValue) {
            const dataTypesSelect = document.getElementById('DataTypes');
            const values = dataTypesValue.split(',');
            if (dataTypesSelect) {
                Array.from(dataTypesSelect.options).forEach(opt => {
                    opt.selected = values.includes(opt.value);
                });
            }
        }
    }

    function showError(message) {
        const alert = document.querySelector('.alert-danger');
        if (alert) {
            alert.textContent = message;
            alert.style.display = 'block';
        }
    }

    // Fetch AI recommendations based on sector and country
    async function fetchFrameworkRecommendations() {
        const sector = document.getElementById('Sector')?.value;
        const country = document.getElementById('Country')?.value;
        const size = document.getElementById('Size')?.value;
        const maturity = document.getElementById('Maturity')?.value;
        const isCritical = document.getElementById('isCritical')?.checked;

        if (!sector) {
            // Fallback to hardcoded blueprints
            updateDerivedFrameworks();
            return;
        }

        try {
            const response = await fetch('/api/lookups/recommend', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    sectorCode: sector,
                    countryCode: country || 'SA',
                    sizeCode: size,
                    maturityCode: maturity,
                    isCriticalInfrastructure: isCritical || false
                })
            });
            if (response.ok) {
                const recommendation = await response.json();
                displayRecommendation(recommendation);
            } else {
                // Fallback to hardcoded blueprints on error
                updateDerivedFrameworks();
            }
        } catch (error) {
            console.error('Error fetching recommendations:', error);
            // Fallback to hardcoded blueprints
            updateDerivedFrameworks();
        }
    }

    function displayRecommendation(data) {
        const section = document.getElementById('derivedFrameworksSection');
        const frameworksList = document.getElementById('frameworksList');
        const guidance = document.getElementById('implementationGuidance');
        const deadlines = document.getElementById('regulatoryDeadlines');

        // API returns { recommendations: [...] }
        const recommendations = data?.recommendations || [];

        if (!recommendations || recommendations.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';

        // Find framework recommendation
        const frameworkRec = recommendations.find(r => r.type === 'frameworks');
        const implementationRec = recommendations.find(r => r.type === 'implementation');
        const maturityRec = recommendations.find(r => r.type === 'maturity');

        // Render frameworks (API returns 'items' array)
        let html = '';
        const frameworks = frameworkRec?.items || frameworkRec?.frameworks || [];
        if (frameworks.length > 0) {
            frameworks.forEach(fw => {
                const mandatoryBadge = fw.isMandatory
                    ? '<span class="badge bg-danger ms-1">Mandatory</span>'
                    : '<span class="badge bg-secondary ms-1">Recommended</span>';

                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 ${fw.isMandatory ? 'border-primary' : 'border-secondary'}">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-shield-alt text-${fw.isMandatory ? 'primary' : 'secondary'}"></i>
                                    ${fw.nameEn || fw.code} ${mandatoryBadge}
                                </h6>
                                <p class="card-text small text-muted">${fw.nameAr || ''}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-light text-dark">${fw.code}</span>
                                    <small class="text-muted">${fw.estimatedControlCount || 0} controls</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        frameworksList.innerHTML = html || '<div class="col-12"><p class="text-muted">Select a sector to see recommended frameworks.</p></div>';

        // Show guidance from framework recommendation
        if (frameworkRec) {
            document.getElementById('guidanceText').textContent = frameworkRec.reason || frameworkRec.message || '';
            document.getElementById('estimatedMonths').textContent = '';
            document.getElementById('priorityFocus').textContent = '';
            guidance.style.display = 'block';
        } else if (implementationRec) {
            document.getElementById('guidanceText').textContent = implementationRec.message || '';
            document.getElementById('estimatedMonths').textContent = implementationRec.recommendedTeamSize ? `Team: ${implementationRec.recommendedTeamSize}+` : '';
            document.getElementById('priorityFocus').textContent = implementationRec.approach || '';
            guidance.style.display = 'block';
        } else {
            guidance.style.display = 'none';
        }

        // Show warnings and info messages
        const warningRec = recommendations.find(r => r.type === 'warning');
        const infoRec = recommendations.find(r => r.type === 'info');

        let alertsHtml = '';
        if (warningRec) {
            alertsHtml += `<li><i class="fas fa-exclamation-triangle text-warning me-1"></i><strong>${warningRec.title}:</strong> ${warningRec.message}</li>`;
        }
        if (infoRec) {
            alertsHtml += `<li><i class="fas fa-info-circle text-info me-1"></i><strong>${infoRec.title}:</strong> ${infoRec.message}</li>`;
        }

        if (alertsHtml) {
            document.getElementById('deadlinesList').innerHTML = alertsHtml;
            deadlines.style.display = 'block';
        } else {
            deadlines.style.display = 'none';
        }
    }

    // Fallback: Hardcoded sector blueprints (used when API is unavailable)
    const sectorBlueprints = {
        'BANKING': {
            name: 'Banking & Financial Services',
            nameAr: 'الخدمات المصرفية والمالية',
            frameworks: [
                { code: 'SAMA-CSF', name: 'SAMA Cybersecurity Framework', priority: 1, mandatory: true, reason: 'Required for all SAMA-regulated financial institutions', controls: 98 },
                { code: 'NCA-ECC', name: 'NCA Essential Cybersecurity Controls', priority: 2, mandatory: true, reason: 'National requirement for critical infrastructure', controls: 114 },
                { code: 'PDPL', name: 'Personal Data Protection Law', priority: 3, mandatory: true, reason: 'Customer data processing requirements', controls: 45 }
            ],
            guidance: 'Focus on transaction security, customer data protection, and regulatory reporting.',
            estimatedMonths: 9,
            priorities: ['Access Control', 'Cryptography', 'Incident Response']
        },
        'HEALTHCARE': {
            name: 'Healthcare & Medical',
            nameAr: 'الرعاية الصحية والطبية',
            frameworks: [
                { code: 'NCA-ECC', name: 'NCA Essential Cybersecurity Controls', priority: 1, mandatory: true, reason: 'Healthcare is critical infrastructure', controls: 114 },
                { code: 'PDPL', name: 'Personal Data Protection Law', priority: 1, mandatory: true, reason: 'Patient health data is sensitive', controls: 45 }
            ],
            guidance: 'Prioritize patient data protection and medical device security.',
            estimatedMonths: 12,
            priorities: ['Data Protection', 'Access Control', 'Patient Privacy']
        },
        'GOVERNMENT': {
            name: 'Government & Public Sector',
            nameAr: 'القطاع الحكومي والعام',
            frameworks: [
                { code: 'NCA-ECC', name: 'NCA Essential Cybersecurity Controls', priority: 1, mandatory: true, reason: 'Mandatory for all government entities', controls: 114 },
                { code: 'NCA-CSCC', name: 'NCA Critical Systems Controls', priority: 1, mandatory: true, reason: 'Government systems are critical infrastructure', controls: 50 }
            ],
            guidance: 'Focus on data classification and NCA compliance.',
            estimatedMonths: 6,
            priorities: ['Data Classification', 'Access Control', 'Cryptography']
        }
    };

    // Map organization type to sector
    function mapTypeToSector(orgType) {
        const mapping = {
            'Government': 'Government',
            'Banking': 'Banking',
            'Insurance': 'Banking',
            'Healthcare': 'Healthcare',
            'Telecom': 'Telecom',
            'Energy': 'Energy',
            'Technology': 'Technology',
            'Manufacturing': 'Energy',
            'Retail': 'Retail',
            'Education': 'Government',
            'Other': 'Technology'
        };
        return mapping[orgType] || 'Technology';
    }

    // Update derived frameworks based on selection
    function updateDerivedFrameworks() {
        const orgType = document.getElementById('OrganizationType')?.value;
        const sectorInput = document.getElementById('Sector')?.value;

        // Determine sector from org type or manual sector input
        let sector = orgType ? mapTypeToSector(orgType) : null;
        if (sectorInput) {
            // Try to match sector input to known sectors
            const sectorLower = sectorInput.toLowerCase();
            if (sectorLower.includes('bank') || sectorLower.includes('financ')) sector = 'Banking';
            else if (sectorLower.includes('health') || sectorLower.includes('medical')) sector = 'Healthcare';
            else if (sectorLower.includes('government') || sectorLower.includes('public')) sector = 'Government';
            else if (sectorLower.includes('telecom')) sector = 'Telecom';
            else if (sectorLower.includes('energy') || sectorLower.includes('oil') || sectorLower.includes('utility')) sector = 'Energy';
            else if (sectorLower.includes('retail') || sectorLower.includes('commerce')) sector = 'Retail';
            else if (sectorLower.includes('tech') || sectorLower.includes('software')) sector = 'Technology';
        }

        const section = document.getElementById('derivedFrameworksSection');
        const frameworksList = document.getElementById('frameworksList');
        const guidance = document.getElementById('implementationGuidance');
        const deadlines = document.getElementById('regulatoryDeadlines');

        if (!sector || !sectorBlueprints[sector]) {
            section.style.display = 'none';
            return;
        }

        const blueprint = sectorBlueprints[sector];
        section.style.display = 'block';

        // Render frameworks
        let html = '';
        blueprint.frameworks.forEach(fw => {
            const mandatoryBadge = fw.mandatory
                ? '<span class="badge bg-danger ms-1">Mandatory</span>'
                : '<span class="badge bg-secondary ms-1">Optional</span>';

            html += `
                <div class="col-md-6 mb-3">
                    <div class="card h-100 ${fw.mandatory ? 'border-primary' : 'border-secondary'}">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="fas fa-shield-alt text-${fw.mandatory ? 'primary' : 'secondary'}"></i>
                                ${fw.name} ${mandatoryBadge}
                            </h6>
                            <p class="card-text small text-muted">${fw.reason}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-light text-dark">${fw.code}</span>
                                <small class="text-muted">${fw.controls} controls</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        frameworksList.innerHTML = html;

        // Show guidance
        document.getElementById('guidanceText').textContent = blueprint.guidance;
        document.getElementById('estimatedMonths').textContent = blueprint.estimatedMonths + ' months';
        document.getElementById('priorityFocus').textContent = blueprint.priorities.join(', ');
        guidance.style.display = 'block';

        // Show deadlines
        let deadlinesHtml = '';
        blueprint.deadlines.forEach(d => {
            deadlinesHtml += `<li><i class="fas fa-exclamation-triangle text-warning me-1"></i>${d}</li>`;
        });
        document.getElementById('deadlinesList').innerHTML = deadlinesHtml;
        deadlines.style.display = 'block';

        // Auto-fill sector field if empty
        const sectorField = document.getElementById('Sector');
        if (!sectorField.value && orgType) {
            sectorField.value = blueprint.name;
        }
    }

    // Attach event listeners
    document.addEventListener('DOMContentLoaded', async function() {
        // Load dropdowns from API
        await loadLookups();

        const orgTypeSelect = document.getElementById('OrganizationType');
        const sectorSelect = document.getElementById('Sector');
        const countrySelect = document.getElementById('Country');
        const criticalCheckbox = document.getElementById('isCritical');

        // Try API-based recommendations first, fallback to hardcoded
        const onSelectionChange = async () => {
            try {
                await fetchFrameworkRecommendations();
            } catch (e) {
                updateDerivedFrameworks();
            }
        };

        orgTypeSelect?.addEventListener('change', onSelectionChange);
        sectorSelect?.addEventListener('change', onSelectionChange);
        countrySelect?.addEventListener('change', onSelectionChange);
        criticalCheckbox?.addEventListener('change', onSelectionChange);

        // Show sector regulator info when sector changes
        sectorSelect?.addEventListener('change', function() {
            const selectedSector = lookupData.sectors.find(s => s.code === this.value);
            const regulatorInfo = document.getElementById('sectorRegulator');
            if (selectedSector && selectedSector.regulatorCode && regulatorInfo) {
                regulatorInfo.textContent = `Regulated by: ${selectedSector.regulatorCode}`;
            } else if (regulatorInfo) {
                regulatorInfo.textContent = '';
            }
        });

        // Initial check if values exist
        if (sectorSelect?.value || orgTypeSelect?.value) {
            onSelectionChange();
        }
    });
</script>
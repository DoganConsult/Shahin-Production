@*
    SHAHIN AI GRC - File Upload Component
    Usage: <partial name="Components/_ShahinFileUpload" model='new {
        Id = "evidenceUpload",
        Name = "files",
        Multiple = true,
        Accept = ".pdf,.docx,.xlsx",
        MaxSize = 10485760,
        ShowPreview = true
    }' />
*@
@{
    dynamic model = ViewData.Model ?? new { };
    var id = model?.Id ?? "shahinUpload" + Guid.NewGuid().ToString("N").Substring(0, 8);
    var name = model?.Name ?? "files";
    var multiple = model?.Multiple ?? false;
    var accept = model?.Accept ?? "*";
    var maxSize = model?.MaxSize ?? 10485760; // 10MB default
    var showPreview = model?.ShowPreview ?? true;
    var dragAndDrop = model?.DragAndDrop ?? true;
    var helpText = model?.HelpText ?? $"Max file size: {maxSize / 1024 / 1024}MB";
}

<div class="shahin-file-upload" id="@id">
    @if (dragAndDrop)
    {
        <div class="shahin-file-dropzone" id="@(id)-dropzone">
            <div class="shahin-file-dropzone-content">
                <i class="bi bi-cloud-arrow-up shahin-file-dropzone-icon"></i>
                <h4 class="shahin-file-dropzone-title">Drag & Drop files here</h4>
                <p class="shahin-file-dropzone-subtitle">or click to browse</p>
                @if (!string.IsNullOrEmpty(helpText))
                {
                    <p class="shahin-file-dropzone-help">@helpText</p>
                }
            </div>
            <input type="file"
                   id="@(id)-input"
                   name="@name"
                   accept="@accept"
                   @(multiple ? Html.Raw("multiple") : null)
                   class="shahin-file-input"
                   data-max-size="@maxSize" />
        </div>
    }
    else
    {
        <label for="@(id)-input" class="shahin-file-label">
            <i class="bi bi-paperclip me-2"></i>
            Choose File@(multiple ? "s" : "")
        </label>
        <input type="file"
               id="@(id)-input"
               name="@name"
               accept="@accept"
               @(multiple ? Html.Raw("multiple") : null)
               class="shahin-file-input"
               data-max-size="@maxSize" />
    }

    @if (showPreview)
    {
        <div class="shahin-file-list" id="@(id)-list"></div>
    }
</div>

<style>
    .shahin-file-upload {
        width: 100%;
    }

    .shahin-file-dropzone {
        position: relative;
        border: 2px dashed var(--shahin-gray-300);
        border-radius: var(--shahin-radius-lg);
        padding: var(--shahin-space-12) var(--shahin-space-6);
        text-align: center;
        cursor: pointer;
        transition: all var(--shahin-transition-base);
        background-color: var(--shahin-gray-50);
    }

    .shahin-file-dropzone:hover {
        border-color: var(--shahin-primary);
        background-color: var(--shahin-primary-light);
    }

    .shahin-file-dropzone.drag-over {
        border-color: var(--shahin-primary);
        background-color: var(--shahin-primary-light);
        transform: scale(1.02);
    }

    .shahin-file-dropzone-icon {
        font-size: var(--shahin-font-size-5xl);
        color: var(--shahin-gray-400);
        margin-bottom: var(--shahin-space-4);
    }

    .shahin-file-dropzone:hover .shahin-file-dropzone-icon {
        color: var(--shahin-primary);
    }

    .shahin-file-dropzone-title {
        font-size: var(--shahin-font-size-lg);
        font-weight: var(--shahin-font-weight-semibold);
        color: var(--shahin-gray-900);
        margin-bottom: var(--shahin-space-2);
    }

    .shahin-file-dropzone-subtitle {
        font-size: var(--shahin-font-size-sm);
        color: var(--shahin-gray-600);
        margin-bottom: var(--shahin-space-2);
    }

    .shahin-file-dropzone-help {
        font-size: var(--shahin-font-size-xs);
        color: var(--shahin-gray-500);
    }

    .shahin-file-input {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        opacity: 0;
        cursor: pointer;
    }

    .shahin-file-label {
        display: inline-block;
        padding: var(--shahin-space-3) var(--shahin-space-5);
        background-color: var(--shahin-primary);
        color: var(--shahin-white);
        border-radius: var(--shahin-radius-base);
        cursor: pointer;
        transition: all var(--shahin-transition-base);
        font-weight: var(--shahin-font-weight-medium);
    }

    .shahin-file-label:hover {
        background-color: var(--shahin-primary-hover);
    }

    .shahin-file-list {
        margin-top: var(--shahin-space-4);
        display: flex;
        flex-direction: column;
        gap: var(--shahin-space-3);
    }

    .shahin-file-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--shahin-space-3) var(--shahin-space-4);
        background-color: var(--shahin-white);
        border: 1px solid var(--shahin-gray-200);
        border-radius: var(--shahin-radius-base);
        animation: shahin-file-appear 0.3s ease-out;
    }

    .shahin-file-info {
        display: flex;
        align-items: center;
        gap: var(--shahin-space-3);
        flex: 1;
    }

    .shahin-file-icon {
        width: 2.5rem;
        height: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--shahin-primary-light);
        color: var(--shahin-primary);
        border-radius: var(--shahin-radius-base);
        font-size: var(--shahin-font-size-lg);
    }

    .shahin-file-details {
        flex: 1;
    }

    .shahin-file-name {
        font-size: var(--shahin-font-size-sm);
        font-weight: var(--shahin-font-weight-medium);
        color: var(--shahin-gray-900);
        margin-bottom: var(--shahin-space-1);
    }

    .shahin-file-size {
        font-size: var(--shahin-font-size-xs);
        color: var(--shahin-gray-600);
    }

    .shahin-file-remove {
        background: none;
        border: none;
        color: var(--shahin-error);
        cursor: pointer;
        padding: var(--shahin-space-2);
        border-radius: var(--shahin-radius-base);
        transition: all var(--shahin-transition-fast);
    }

    .shahin-file-remove:hover {
        background-color: var(--shahin-error-light);
    }

    @@keyframes shahin-file-appear {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

@section Scripts {
    <script>
        (function() {
            var container = document.getElementById('@id');
            if (!container) return;

            var input = document.getElementById('@(id)-input');
            var dropzone = document.getElementById('@(id)-dropzone');
            var fileList = document.getElementById('@(id)-list');
            var maxSize = parseInt(input.getAttribute('data-max-size'));
            var files = [];

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                var k = 1024;
                var sizes = ['Bytes', 'KB', 'MB', 'GB'];
                var i = Math.floor(Math.log(bytes) / Math.log(k));
                return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
            }

            function getFileIcon(filename) {
                var ext = filename.split('.').pop().toLowerCase();
                var iconMap = {
                    'pdf': 'file-pdf-fill',
                    'doc': 'file-word-fill',
                    'docx': 'file-word-fill',
                    'xls': 'file-excel-fill',
                    'xlsx': 'file-excel-fill',
                    'ppt': 'file-ppt-fill',
                    'pptx': 'file-ppt-fill',
                    'jpg': 'file-image-fill',
                    'jpeg': 'file-image-fill',
                    'png': 'file-image-fill',
                    'gif': 'file-image-fill',
                    'zip': 'file-zip-fill',
                    'rar': 'file-zip-fill'
                };
                return iconMap[ext] || 'file-earmark-fill';
            }

            function addFileToList(file, index) {
                var fileItem = document.createElement('div');
                fileItem.className = 'shahin-file-item';
                fileItem.innerHTML =
                    '<div class="shahin-file-info">' +
                    '<div class="shahin-file-icon"><i class="bi bi-' + getFileIcon(file.name) + '"></i></div>' +
                    '<div class="shahin-file-details">' +
                    '<div class="shahin-file-name">' + file.name + '</div>' +
                    '<div class="shahin-file-size">' + formatFileSize(file.size) + '</div>' +
                    '</div>' +
                    '</div>' +
                    '<button type="button" class="shahin-file-remove" data-index="' + index + '">' +
                    '<i class="bi bi-x-lg"></i>' +
                    '</button>';

                fileList.appendChild(fileItem);

                fileItem.querySelector('.shahin-file-remove').addEventListener('click', function() {
                    var idx = parseInt(this.getAttribute('data-index'));
                    files.splice(idx, 1);
                    fileItem.remove();
                });
            }

            function handleFiles(newFiles) {
                for (var i = 0; i < newFiles.length; i++) {
                    var file = newFiles[i];

                    if (file.size > maxSize) {
                        alert('File "' + file.name + '" exceeds maximum size of ' + formatFileSize(maxSize));
                        continue;
                    }

                    files.push(file);
                    addFileToList(file, files.length - 1);
                }
            }

            input.addEventListener('change', function(e) {
                handleFiles(this.files);
            });

            if (dropzone) {
                ['dragenter', 'dragover'].forEach(function(eventName) {
                    dropzone.addEventListener(eventName, function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        this.classList.add('drag-over');
                    });
                });

                ['dragleave', 'drop'].forEach(function(eventName) {
                    dropzone.addEventListener(eventName, function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        this.classList.remove('drag-over');
                    });
                });

                dropzone.addEventListener('drop', function(e) {
                    var dt = e.dataTransfer;
                    handleFiles(dt.files);
                });
            }
        })();
    </script>
}

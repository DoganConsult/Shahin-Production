@model GrcMvc.ViewComponents.PermissionMatrixModel

<div class="permission-matrix-container">
    <div class="matrix-toolbar d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-2">
            <select class="form-select form-select-sm" style="width: 150px;" id="module-filter">
                <option value="">All Modules</option>
                <option value="risk">Risk Management</option>
                <option value="compliance">Compliance</option>
                <option value="audit">Audit</option>
                <option value="admin">Administration</option>
            </select>
            <input type="text" class="form-control form-control-sm" style="width: 200px;"
                   placeholder="Search permissions..." id="permission-search">
        </div>
        <div>
            <button class="btn btn-sm btn-outline-secondary me-2" onclick="resetChanges()">
                <i class="bi bi-arrow-counterclockwise me-1"></i>Reset
            </button>
            <button class="btn btn-sm btn-primary" onclick="savePermissions()">
                <i class="bi bi-save me-1"></i>Save Changes
            </button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-hover permission-table">
            <thead class="table-dark sticky-top">
                <tr>
                    <th class="sticky-col" style="min-width: 150px;">Role / Permission</th>
                    @foreach (var permission in Model.PermissionColumns.Take(15))
                    {
                        <th class="text-center small" style="min-width: 80px; writing-mode: vertical-rl; text-orientation: mixed; height: 120px;">
                            @permission.Replace("_", " ")
                        </th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var role in Model.Roles)
                {
                    <tr>
                        <td class="sticky-col fw-medium">
                            <i class="bi bi-person-badge me-2"></i>@role.RoleName
                        </td>
                        @foreach (var permission in Model.PermissionColumns.Take(15))
                        {
                            var hasPermission = role.Permissions.ContainsKey(permission) && role.Permissions[permission];
                            <td class="text-center permission-cell" data-role="@role.RoleId" data-permission="@permission">
                                <input type="checkbox" class="form-check-input permission-checkbox"
                                       @(hasPermission ? "checked" : "")
                                       onchange="togglePermission('@role.RoleId', '@permission', this.checked)">
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="mt-3">
        <div class="d-flex align-items-center gap-3 text-muted small">
            <span><i class="bi bi-check-square-fill text-success me-1"></i> Granted</span>
            <span><i class="bi bi-square text-secondary me-1"></i> Denied</span>
            <span><i class="bi bi-exclamation-triangle text-warning me-1"></i> Modified (unsaved)</span>
        </div>
    </div>
</div>

<script>
var permissionChanges = {};

function togglePermission(roleId, permission, granted) {
    const key = `${roleId}:${permission}`;
    permissionChanges[key] = granted;

    const cell = document.querySelector(`[data-role="${roleId}"][data-permission="${permission}"]`);
    cell.classList.add('modified');
}

function savePermissions() {
    if (Object.keys(permissionChanges).length === 0) {
        alert('No changes to save');
        return;
    }

    fetch('/api/rbac/permissions/bulk-update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ changes: permissionChanges })
    }).then(response => {
        if (response.ok) {
            alert('Permissions saved successfully!');
            document.querySelectorAll('.modified').forEach(el => el.classList.remove('modified'));
            permissionChanges = {};
        } else {
            alert('Failed to save permissions');
        }
    });
}

function resetChanges() {
    permissionChanges = {};
    document.querySelectorAll('.modified').forEach(cell => {
        cell.classList.remove('modified');
        const checkbox = cell.querySelector('input');
        checkbox.checked = !checkbox.checked; // Revert
    });
}

// Search filter
document.getElementById('permission-search')?.addEventListener('input', function(e) {
    const search = e.target.value.toLowerCase();
    document.querySelectorAll('.permission-table th:not(.sticky-col)').forEach((th, i) => {
        const match = th.textContent.toLowerCase().includes(search);
        th.style.display = match ? '' : 'none';
        document.querySelectorAll(`.permission-table td:nth-child(${i + 2})`).forEach(td => {
            td.style.display = match ? '' : 'none';
        });
    });
});
</script>

<style>
.permission-table {
    font-size: 0.875rem;
}

.sticky-col {
    position: sticky;
    left: 0;
    background: white;
    z-index: 1;
}

.dark .sticky-col {
    background: #1e293b;
}

.permission-cell {
    transition: background-color 0.2s;
}

.permission-cell:hover {
    background-color: #f0fdf4;
}

.permission-cell.modified {
    background-color: #fef3c7 !important;
}

.permission-checkbox {
    cursor: pointer;
    width: 18px;
    height: 18px;
}

.permission-checkbox:checked {
    background-color: #10b981;
    border-color: #10b981;
}
</style>

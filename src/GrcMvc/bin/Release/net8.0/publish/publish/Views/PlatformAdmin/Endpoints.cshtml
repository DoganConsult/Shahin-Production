@{
    ViewData["Title"] = "Endpoint Management";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-diagram-3"></i> API Endpoint Management</h2>
                <div>
                    <button class="btn btn-primary" onclick="refreshEndpoints()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                    <button class="btn btn-success" onclick="exportEndpoints()">
                        <i class="bi bi-download"></i> Export
                    </button>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4" id="statisticsCards">
                <div class="col-md-3">
                    <div class="card text-white bg-primary">
                        <div class="card-body">
                            <h5 class="card-title">Total Endpoints</h5>
                            <h2 id="totalEndpoints">-</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-success">
                        <div class="card-body">
                            <h5 class="card-title">Controllers</h5>
                            <h2 id="totalControllers">-</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-info">
                        <div class="card-body">
                            <h5 class="card-title">Authenticated</h5>
                            <h2 id="authEndpoints">-</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-warning">
                        <div class="card-body">
                            <h5 class="card-title">Public</h5>
                            <h2 id="publicEndpoints">-</h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label>Filter by Controller:</label>
                            <select id="controllerFilter" class="form-select" onchange="filterEndpoints()">
                                <option value="">All Controllers</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label>Filter by HTTP Method:</label>
                            <select id="methodFilter" class="form-select" onchange="filterEndpoints()">
                                <option value="">All Methods</option>
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                                <option value="PUT">PUT</option>
                                <option value="DELETE">DELETE</option>
                                <option value="PATCH">PATCH</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label>Search:</label>
                            <input type="text" id="searchFilter" class="form-control" placeholder="Search endpoints..." onkeyup="filterEndpoints()">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Endpoints Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">API Endpoints</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="endpointsTable">
                            <thead>
                                <tr>
                                    <th>HTTP Method</th>
                                    <th>Route</th>
                                    <th>Controller</th>
                                    <th>Action</th>
                                    <th>Auth Required</th>
                                    <th>Policy</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="endpointsTableBody">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let allEndpoints = [];
        let statistics = null;

        // Load endpoints on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadStatistics();
            loadEndpoints();
        });

        async function loadStatistics() {
            try {
                const response = await fetch('/api/endpoints/statistics', {
                    headers: {
                        'Authorization': 'Bearer ' + getAuthToken()
                    }
                });
                const data = await response.json();
                if (data.success) {
                    statistics = data.statistics;
                    updateStatisticsCards();
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        async function loadEndpoints() {
            try {
                const response = await fetch('/api/endpoints', {
                    headers: {
                        'Authorization': 'Bearer ' + getAuthToken()
                    }
                });
                const data = await response.json();
                if (data.success) {
                    allEndpoints = data.endpoints;
                    populateControllerFilter();
                    renderEndpoints(allEndpoints);
                }
            } catch (error) {
                console.error('Error loading endpoints:', error);
                document.getElementById('endpointsTableBody').innerHTML = 
                    '<tr><td colspan="7" class="text-center text-danger">Error loading endpoints</td></tr>';
            }
        }

        function updateStatisticsCards() {
            if (!statistics) return;
            document.getElementById('totalEndpoints').textContent = statistics.totalEndpoints;
            document.getElementById('totalControllers').textContent = statistics.controllers;
            document.getElementById('authEndpoints').textContent = statistics.authenticatedEndpoints;
            document.getElementById('publicEndpoints').textContent = statistics.publicEndpoints;
        }

        function populateControllerFilter() {
            const controllers = [...new Set(allEndpoints.map(e => e.controllerName))].sort();
            const select = document.getElementById('controllerFilter');
            controllers.forEach(controller => {
                const option = document.createElement('option');
                option.value = controller;
                option.textContent = controller;
                select.appendChild(option);
            });
        }

        function filterEndpoints() {
            const controllerFilter = document.getElementById('controllerFilter').value;
            const methodFilter = document.getElementById('methodFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

            let filtered = allEndpoints;

            if (controllerFilter) {
                filtered = filtered.filter(e => e.controllerName === controllerFilter);
            }

            if (methodFilter) {
                filtered = filtered.filter(e => e.httpMethod === methodFilter);
            }

            if (searchFilter) {
                filtered = filtered.filter(e => 
                    e.route.toLowerCase().includes(searchFilter) ||
                    e.controllerName.toLowerCase().includes(searchFilter) ||
                    e.actionName.toLowerCase().includes(searchFilter)
                );
            }

            renderEndpoints(filtered);
        }

        function renderEndpoints(endpoints) {
            const tbody = document.getElementById('endpointsTableBody');
            
            if (endpoints.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No endpoints found</td></tr>';
                return;
            }

            tbody.innerHTML = endpoints.map(endpoint => `
                <tr>
                    <td>
                        <span class="badge bg-${getMethodColor(endpoint.httpMethod)}">
                            ${endpoint.httpMethod}
                        </span>
                    </td>
                    <td><code>/${endpoint.route}</code></td>
                    <td>${endpoint.controllerName}</td>
                    <td>${endpoint.actionName}</td>
                    <td>
                        ${endpoint.requiresAuth 
                            ? '<span class="badge bg-danger">Yes</span>' 
                            : '<span class="badge bg-success">No</span>'}
                    </td>
                    <td>${endpoint.policy || '-'}</td>
                    <td>
                        ${endpoint.isProductionReady 
                            ? '<span class="badge bg-success">Production Ready</span>' 
                            : '<span class="badge bg-warning">Not Ready</span>'}
                    </td>
                </tr>
            `).join('');
        }

        function getMethodColor(method) {
            const colors = {
                'GET': 'primary',
                'POST': 'success',
                'PUT': 'info',
                'DELETE': 'danger',
                'PATCH': 'warning'
            };
            return colors[method] || 'secondary';
        }

        function refreshEndpoints() {
            allEndpoints = [];
            document.getElementById('endpointsTableBody').innerHTML = 
                '<tr><td colspan="7" class="text-center"><div class="spinner-border"></div></td></tr>';
            loadStatistics();
            loadEndpoints();
        }

        function exportEndpoints() {
            const dataStr = JSON.stringify(allEndpoints, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'api-endpoints-' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
        }

        function getAuthToken() {
            // Get token from localStorage or cookie
            return localStorage.getItem('authToken') || '';
        }
    </script>
}

apiVersion: v1
kind: ConfigMap
metadata:
  name: haproxy-config
  namespace: shahin-grc
  labels:
    app.kubernetes.io/name: haproxy
    app.kubernetes.io/component: load-balancer
data:
  haproxy.cfg: |
    global
        maxconn 1000
        log stdout format raw local0
        stats socket /var/run/haproxy.sock mode 660 level admin
        stats timeout 30s

    defaults
        mode tcp
        log global
        option tcplog
        option dontlognull
        option redispatch
        retries 3
        timeout connect 5s
        timeout client 30s
        timeout server 30s
        timeout check 5s

    # PostgreSQL Write (Primary only)
    listen postgres-write
        bind *:5432
        mode tcp
        option httpchk GET /primary
        http-check expect status 200
        default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
        server postgres-0 postgres-0.postgres-headless:5432 check port 8008
        server postgres-1 postgres-1.postgres-headless:5432 check port 8008 backup
        server postgres-2 postgres-2.postgres-headless:5432 check port 8008 backup

    # PostgreSQL Read (Load balanced replicas)
    listen postgres-read
        bind *:5433
        mode tcp
        balance roundrobin
        option httpchk GET /replica
        http-check expect status 200
        default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
        server postgres-0 postgres-0.postgres-headless:5432 check port 8008
        server postgres-1 postgres-1.postgres-headless:5432 check port 8008
        server postgres-2 postgres-2.postgres-headless:5432 check port 8008

    # HAProxy Stats
    listen stats
        bind *:8404
        mode http
        stats enable
        stats uri /stats
        stats refresh 10s
        stats admin if LOCALHOST

    # Health check endpoint
    frontend health
        bind *:8405
        mode http
        monitor-uri /health
        option httplog

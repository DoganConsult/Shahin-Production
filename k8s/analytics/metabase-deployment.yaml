# =============================================================================
# Metabase - Self-Service Analytics
# =============================================================================
# Easy-to-use business intelligence tool
# Port: 3033
# =============================================================================
---
apiVersion: v1
kind: Service
metadata:
  name: metabase
  namespace: shahin-grc
  labels:
    app.kubernetes.io/name: metabase
    app.kubernetes.io/component: analytics
spec:
  type: ClusterIP
  ports:
  - name: http
    port: 3033
    targetPort: 3000
  selector:
    app.kubernetes.io/name: metabase
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: metabase
  namespace: shahin-grc
  labels:
    app.kubernetes.io/name: metabase
    app.kubernetes.io/component: analytics
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: metabase
  template:
    metadata:
      labels:
        app.kubernetes.io/name: metabase
        app.kubernetes.io/component: analytics
    spec:
      containers:
      - name: metabase
        image: metabase/metabase:v0.48.6
        imagePullPolicy: IfNotPresent
        ports:
        - name: http
          containerPort: 3000
        env:
        - name: MB_DB_TYPE
          value: "postgres"
        - name: MB_DB_DBNAME
          value: "metabase"
        - name: MB_DB_PORT
          value: "5432"
        - name: MB_DB_HOST
          value: "postgres-headless"
        - name: MB_DB_USER
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: POSTGRES_USER
        - name: MB_DB_PASS
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: POSTGRES_PASSWORD
        - name: JAVA_TIMEZONE
          value: "UTC"
        - name: MB_SITE_NAME
          value: "Shahin GRC Analytics"
        - name: MB_SITE_URL
          value: "https://portal.shahin-ai.com/metabase"
        resources:
          requests:
            cpu: 250m
            memory: 512Mi
          limits:
            cpu: 2000m
            memory: 2Gi
        readinessProbe:
          httpGet:
            path: /api/health
            port: 3000
          initialDelaySeconds: 60
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /api/health
            port: 3000
          initialDelaySeconds: 120
          periodSeconds: 30

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: backup-storage
  namespace: shahin-grc
  labels:
    app.kubernetes.io/name: backup
    app.kubernetes.io/component: storage
spec:
  accessModes:
  - ReadWriteOnce
  storageClassName: hostpath
  resources:
    requests:
      storage: 100Gi
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: backup-scripts
  namespace: shahin-grc
data:
  backup.sh: |
    #!/bin/bash
    set -e

    # Configuration
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_DIR="/backups"
    RETENTION_DAYS=30

    echo "=== Starting PostgreSQL Backup - $TIMESTAMP ==="

    # Backup main database
    echo "Backing up GrcMvcDb..."
    PGPASSWORD="$POSTGRES_PASSWORD" pg_dump \
      -h haproxy \
      -p 5432 \
      -U "$POSTGRES_USER" \
      -d GrcMvcDb \
      -Fc \
      -Z 9 \
      -f "$BACKUP_DIR/GrcMvcDb_$TIMESTAMP.dump"

    # Backup auth database
    echo "Backing up GrcAuthDb..."
    PGPASSWORD="$POSTGRES_PASSWORD" pg_dump \
      -h haproxy \
      -p 5432 \
      -U "$POSTGRES_USER" \
      -d GrcAuthDb \
      -Fc \
      -Z 9 \
      -f "$BACKUP_DIR/GrcAuthDb_$TIMESTAMP.dump"

    # Get backup sizes
    GRC_SIZE=$(du -h "$BACKUP_DIR/GrcMvcDb_$TIMESTAMP.dump" | cut -f1)
    AUTH_SIZE=$(du -h "$BACKUP_DIR/GrcAuthDb_$TIMESTAMP.dump" | cut -f1)

    echo "Backup sizes: GrcMvcDb=$GRC_SIZE, GrcAuthDb=$AUTH_SIZE"

    # Verify backups
    echo "Verifying backup integrity..."
    pg_restore --list "$BACKUP_DIR/GrcMvcDb_$TIMESTAMP.dump" > /dev/null
    pg_restore --list "$BACKUP_DIR/GrcAuthDb_$TIMESTAMP.dump" > /dev/null
    echo "Backup verification successful"

    # Clean up old backups
    echo "Cleaning up backups older than $RETENTION_DAYS days..."
    find "$BACKUP_DIR" -name "*.dump" -mtime +$RETENTION_DAYS -delete

    # List remaining backups
    echo "Current backups:"
    ls -lh "$BACKUP_DIR"/*.dump 2>/dev/null || echo "No backups found"

    # Calculate total storage used
    TOTAL_SIZE=$(du -sh "$BACKUP_DIR" | cut -f1)
    echo "Total backup storage used: $TOTAL_SIZE"

    echo "=== Backup completed successfully at $(date) ==="

  restore.sh: |
    #!/bin/bash
    set -e

    # Usage: restore.sh <backup_file>
    if [ -z "$1" ]; then
      echo "Usage: $0 <backup_file>"
      echo "Available backups:"
      ls -lh /backups/*.dump
      exit 1
    fi

    BACKUP_FILE="$1"

    if [ ! -f "$BACKUP_FILE" ]; then
      echo "Error: Backup file not found: $BACKUP_FILE"
      exit 1
    fi

    echo "=== Starting restore from $BACKUP_FILE ==="
    echo "WARNING: This will overwrite existing data!"

    # Determine database name from filename
    if [[ "$BACKUP_FILE" == *"GrcMvcDb"* ]]; then
      DB_NAME="GrcMvcDb"
    elif [[ "$BACKUP_FILE" == *"GrcAuthDb"* ]]; then
      DB_NAME="GrcAuthDb"
    else
      echo "Error: Cannot determine database name from filename"
      exit 1
    fi

    echo "Restoring to database: $DB_NAME"

    # Restore
    PGPASSWORD="$POSTGRES_PASSWORD" pg_restore \
      -h haproxy \
      -p 5432 \
      -U "$POSTGRES_USER" \
      -d "$DB_NAME" \
      --clean \
      --if-exists \
      --no-owner \
      --no-privileges \
      "$BACKUP_FILE"

    echo "=== Restore completed successfully ==="
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgresql-backup
  namespace: shahin-grc
  labels:
    app.kubernetes.io/name: backup
    app.kubernetes.io/component: database
spec:
  schedule: "0 2 * * *"  # Daily at 2 AM UTC
  timeZone: "UTC"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 3600  # 1 hour timeout
      template:
        metadata:
          labels:
            app.kubernetes.io/name: backup
        spec:
          restartPolicy: OnFailure

          containers:
          - name: backup
            image: postgres:16-alpine
            imagePullPolicy: IfNotPresent

            command: ["/bin/bash", "/scripts/backup.sh"]

            env:
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: db-credentials
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: db-credentials
                  key: POSTGRES_PASSWORD

            resources:
              requests:
                cpu: 200m
                memory: 256Mi
              limits:
                cpu: 1000m
                memory: 1Gi

            volumeMounts:
            - name: backup-storage
              mountPath: /backups
            - name: scripts
              mountPath: /scripts

          volumes:
          - name: backup-storage
            persistentVolumeClaim:
              claimName: backup-storage
          - name: scripts
            configMap:
              name: backup-scripts
              defaultMode: 0755
---
# Manual backup job template
apiVersion: batch/v1
kind: Job
metadata:
  name: manual-backup
  namespace: shahin-grc
  labels:
    app.kubernetes.io/name: backup
    app.kubernetes.io/component: manual
spec:
  backoffLimit: 1
  activeDeadlineSeconds: 1800
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: backup
        image: postgres:16-alpine
        command: ["/bin/bash", "/scripts/backup.sh"]
        env:
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: POSTGRES_USER
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: POSTGRES_PASSWORD
        volumeMounts:
        - name: backup-storage
          mountPath: /backups
        - name: scripts
          mountPath: /scripts
      volumes:
      - name: backup-storage
        persistentVolumeClaim:
          claimName: backup-storage
      - name: scripts
        configMap:
          name: backup-scripts
          defaultMode: 0755

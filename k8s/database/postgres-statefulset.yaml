# PostgreSQL HA Cluster with Patroni
# 3-node cluster with automatic failover via etcd consensus
apiVersion: v1
kind: Service
metadata:
  name: postgres-headless
  namespace: shahin-grc
  labels:
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/component: database
spec:
  clusterIP: None
  ports:
  - name: postgresql
    port: 5432
    targetPort: 5432
  - name: patroni
    port: 8008
    targetPort: 8008
  selector:
    app.kubernetes.io/name: postgresql
---
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: shahin-grc
  labels:
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/component: database
spec:
  type: ClusterIP
  ports:
  - name: postgresql
    port: 5432
    targetPort: 5432
  selector:
    app.kubernetes.io/name: postgresql
    role: primary
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-config
  namespace: shahin-grc
data:
  # Patroni configuration for automatic failover
  patroni.yml: |
    scope: shahin-postgres
    name: ${POD_NAME}

    restapi:
      listen: 0.0.0.0:8008
      connect_address: ${POD_IP}:8008

    etcd3:
      hosts: etcd-0.etcd-headless:2379,etcd-1.etcd-headless:2379,etcd-2.etcd-headless:2379

    bootstrap:
      dcs:
        ttl: 30
        loop_wait: 10
        retry_timeout: 10
        maximum_lag_on_failover: 1048576
        postgresql:
          use_pg_rewind: true
          use_slots: true
          parameters:
            wal_level: replica
            hot_standby: on
            max_wal_senders: 10
            max_replication_slots: 10
            wal_keep_size: 1GB
            max_connections: 200
            shared_buffers: 512MB
            effective_cache_size: 1536MB
            work_mem: 16MB
            maintenance_work_mem: 128MB
            checkpoint_completion_target: 0.9
            wal_buffers: 16MB
            default_statistics_target: 100
            random_page_cost: 1.1
            effective_io_concurrency: 200
            min_wal_size: 1GB
            max_wal_size: 4GB
            synchronous_commit: on

      initdb:
        - encoding: UTF8
        - data-checksums

      pg_hba:
        - host replication replicator 0.0.0.0/0 md5
        - host all all 0.0.0.0/0 md5

      users:
        shahin_admin:
          password: ${POSTGRES_PASSWORD}
          options:
            - createrole
            - createdb
        replicator:
          password: ${REPLICATION_PASSWORD}
          options:
            - replication

    postgresql:
      listen: 0.0.0.0:5432
      connect_address: ${POD_IP}:5432
      data_dir: /var/lib/postgresql/data/pgdata
      authentication:
        replication:
          username: replicator
          password: ${REPLICATION_PASSWORD}
        superuser:
          username: postgres
          password: ${POSTGRES_PASSWORD}
      parameters:
        unix_socket_directories: /var/run/postgresql

  init-databases.sql: |
    -- Create application databases
    CREATE DATABASE "GrcMvcDb" OWNER shahin_admin;
    CREATE DATABASE "GrcAuthDb" OWNER shahin_admin;

    -- Grant permissions
    GRANT ALL PRIVILEGES ON DATABASE "GrcMvcDb" TO shahin_admin;
    GRANT ALL PRIVILEGES ON DATABASE "GrcAuthDb" TO shahin_admin;
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: shahin-grc
  labels:
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/component: database
spec:
  serviceName: postgres-headless
  replicas: 3
  podManagementPolicy: Parallel
  selector:
    matchLabels:
      app.kubernetes.io/name: postgresql
  template:
    metadata:
      labels:
        app.kubernetes.io/name: postgresql
        app.kubernetes.io/component: database
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8008"
    spec:
      securityContext:
        fsGroup: 999
        runAsUser: 999
        runAsGroup: 999

      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                app.kubernetes.io/name: postgresql
            topologyKey: kubernetes.io/hostname

      initContainers:
      - name: init-chmod
        image: busybox:1.36
        command: ['sh', '-c', 'chown -R 999:999 /var/lib/postgresql/data']
        volumeMounts:
        - name: data
          mountPath: /var/lib/postgresql/data

      containers:
      - name: patroni
        image: patroni/patroni:3.2.2
        imagePullPolicy: IfNotPresent

        ports:
        - name: postgresql
          containerPort: 5432
        - name: patroni
          containerPort: 8008

        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: PATRONI_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: PATRONI_KUBERNETES_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: PATRONI_POSTGRESQL_DATA_DIR
          value: /var/lib/postgresql/data/pgdata
        - name: PATRONI_POSTGRESQL_CONNECT_ADDRESS
          value: "$(POD_IP):5432"
        - name: PATRONI_RESTAPI_CONNECT_ADDRESS
          value: "$(POD_IP):8008"
        - name: PATRONI_SCOPE
          value: shahin-postgres
        - name: PATRONI_ETCD3_HOSTS
          value: "etcd-0.etcd-headless:2379,etcd-1.etcd-headless:2379,etcd-2.etcd-headless:2379"
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: POSTGRES_USER
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: POSTGRES_PASSWORD
        - name: POSTGRES_DB
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: POSTGRES_DB
        - name: PATRONI_REPLICATION_USERNAME
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: REPLICATION_USER
        - name: PATRONI_REPLICATION_PASSWORD
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: REPLICATION_PASSWORD
        - name: REPLICATION_PASSWORD
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: REPLICATION_PASSWORD
        - name: PATRONI_SUPERUSER_USERNAME
          value: postgres
        - name: PATRONI_SUPERUSER_PASSWORD
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: POSTGRES_PASSWORD

        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 2000m
            memory: 4Gi

        startupProbe:
          httpGet:
            path: /health
            port: 8008
          initialDelaySeconds: 10
          periodSeconds: 5
          failureThreshold: 60

        livenessProbe:
          httpGet:
            path: /liveness
            port: 8008
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 6

        readinessProbe:
          httpGet:
            path: /readiness
            port: 8008
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3

        volumeMounts:
        - name: data
          mountPath: /var/lib/postgresql/data
        - name: config
          mountPath: /etc/patroni

      terminationGracePeriodSeconds: 60

      volumes:
      - name: config
        configMap:
          name: postgres-config

  volumeClaimTemplates:
  - metadata:
      name: data
      labels:
        app.kubernetes.io/name: postgresql
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: longhorn
      resources:
        requests:
          storage: 50Gi

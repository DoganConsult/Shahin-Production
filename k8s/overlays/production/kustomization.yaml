# Production Environment Overlay
# Full HA: 3 replicas, maximum resources, strict security
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: shahin-grc

namePrefix: ""
nameSuffix: ""

commonLabels:
  environment: production
  app.kubernetes.io/instance: production

resources:
  - ../../base
  - namespace.yaml
  - secrets.yaml
  - ingress-patch.yaml

# Production-specific patches
patches:
  # PostgreSQL: 3 replicas (full HA)
  - target:
      kind: StatefulSet
      name: postgres
    patch: |
      - op: replace
        path: /spec/replicas
        value: 3
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "1000m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "2Gi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "4000m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "8Gi"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: PATRONI_POSTGRESQL_PARAMETERS_shared_buffers
          value: "2GB"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: PATRONI_POSTGRESQL_PARAMETERS_effective_cache_size
          value: "6GB"

  # etcd: 3 replicas (required for consensus)
  - target:
      kind: StatefulSet
      name: etcd
    patch: |
      - op: replace
        path: /spec/replicas
        value: 3
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "200m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "512Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "1000m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "1Gi"

  # Redis Master: Production resources
  - target:
      kind: StatefulSet
      name: redis-master
    patch: |
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "200m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "512Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "1000m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "2Gi"

  # Redis Sentinel: 3 replicas for quorum
  - target:
      kind: StatefulSet
      name: redis-sentinel
    patch: |
      - op: replace
        path: /spec/replicas
        value: 3
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "100m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "128Mi"

  # Kafka: 3 brokers (full HA)
  - target:
      kind: StatefulSet
      name: kafka
    patch: |
      - op: replace
        path: /spec/replicas
        value: 3
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "1000m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "2Gi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "4000m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "4Gi"
      - op: replace
        path: /spec/template/spec/containers/0/env/4/value
        value: "-Xmx2G -Xms2G"

  # GRC Portal: 2 minimum replicas with production resources
  - target:
      kind: Deployment
      name: grc-portal
    patch: |
      - op: replace
        path: /spec/replicas
        value: 3
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "500m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "1Gi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "4000m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "4Gi"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: ASPNETCORE_ENVIRONMENT
          value: "Production"

  # HPA: 2-6 replicas for production
  - target:
      kind: HorizontalPodAutoscaler
      name: grc-portal-hpa
    patch: |
      - op: replace
        path: /spec/minReplicas
        value: 2
      - op: replace
        path: /spec/maxReplicas
        value: 6
      - op: replace
        path: /spec/metrics/0/resource/target/averageUtilization
        value: 70
      - op: replace
        path: /spec/metrics/1/resource/target/averageUtilization
        value: 80

  # PDBs: Strict availability in production
  - target:
      kind: PodDisruptionBudget
      name: postgres-pdb
    patch: |
      - op: replace
        path: /spec/minAvailable
        value: 2

  - target:
      kind: PodDisruptionBudget
      name: etcd-pdb
    patch: |
      - op: replace
        path: /spec/minAvailable
        value: 2

  - target:
      kind: PodDisruptionBudget
      name: kafka-pdb
    patch: |
      - op: replace
        path: /spec/minAvailable
        value: 2

  - target:
      kind: PodDisruptionBudget
      name: redis-sentinel-pdb
    patch: |
      - op: replace
        path: /spec/minAvailable
        value: 2

  # HAProxy: 3 replicas for production
  - target:
      kind: Deployment
      name: haproxy
    patch: |
      - op: replace
        path: /spec/replicas
        value: 3

  # PgBouncer: 3 replicas for production
  - target:
      kind: Deployment
      name: pgbouncer
    patch: |
      - op: replace
        path: /spec/replicas
        value: 3

# ConfigMap overrides for production
configMapGenerator:
  - name: production-config
    literals:
      - LOG_LEVEL=Warning
      - ENABLE_SWAGGER=false
      - ENABLE_DETAILED_ERRORS=false
      - RATE_LIMIT_ENABLED=true

# Redis replicas for production
replicas:
  - name: redis-replica
    count: 2

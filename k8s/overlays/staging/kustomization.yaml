# Staging Environment Overlay
# 2 replicas for critical services, moderate resources, production-like setup
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: shahin-grc-staging

namePrefix: staging-
nameSuffix: ""

commonLabels:
  environment: staging
  app.kubernetes.io/instance: staging

resources:
  - ../../base
  - namespace.yaml
  - secrets.yaml
  - ingress-patch.yaml

# Staging-specific patches
patches:
  # PostgreSQL: 2 replicas (minimal HA)
  - target:
      kind: StatefulSet
      name: postgres
    patch: |
      - op: replace
        path: /spec/replicas
        value: 2
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "500m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "1Gi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "1500m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "3Gi"

  # etcd: 3 replicas (required for consensus)
  - target:
      kind: StatefulSet
      name: etcd
    patch: |
      - op: replace
        path: /spec/replicas
        value: 3
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "100m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "256Mi"

  # Redis: Keep master, reduce replicas
  - target:
      kind: StatefulSet
      name: redis-master
    patch: |
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "100m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "256Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "500m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "512Mi"

  # Redis Sentinel: 3 replicas (required for quorum)
  - target:
      kind: StatefulSet
      name: redis-sentinel
    patch: |
      - op: replace
        path: /spec/replicas
        value: 3

  # Kafka: 2 brokers for staging
  - target:
      kind: StatefulSet
      name: kafka
    patch: |
      - op: replace
        path: /spec/replicas
        value: 2
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "500m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "1Gi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "1500m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "2Gi"

  # GRC Portal: 2 replicas with moderate resources
  - target:
      kind: Deployment
      name: grc-portal
    patch: |
      - op: replace
        path: /spec/replicas
        value: 2
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "250m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "512Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "1500m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "2Gi"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: ASPNETCORE_ENVIRONMENT
          value: "Staging"

  # HPA: 2-4 replicas for staging
  - target:
      kind: HorizontalPodAutoscaler
      name: grc-portal-hpa
    patch: |
      - op: replace
        path: /spec/minReplicas
        value: 2
      - op: replace
        path: /spec/maxReplicas
        value: 4

  # PDBs: Allow 1 unavailable
  - target:
      kind: PodDisruptionBudget
      name: postgres-pdb
    patch: |
      - op: replace
        path: /spec/minAvailable
        value: 1

  - target:
      kind: PodDisruptionBudget
      name: etcd-pdb
    patch: |
      - op: replace
        path: /spec/minAvailable
        value: 2

  - target:
      kind: PodDisruptionBudget
      name: kafka-pdb
    patch: |
      - op: replace
        path: /spec/minAvailable
        value: 1

# ConfigMap overrides for staging
configMapGenerator:
  - name: staging-config
    literals:
      - LOG_LEVEL=Information
      - ENABLE_SWAGGER=true
      - ENABLE_DETAILED_ERRORS=false

# Redis replicas for staging
replicas:
  - name: redis-replica
    count: 1

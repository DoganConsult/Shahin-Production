# Development Environment Overlay
# Single replicas, minimal resources, local development focus
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: shahin-grc-dev

namePrefix: dev-
nameSuffix: ""

commonLabels:
  environment: development
  app.kubernetes.io/instance: dev

resources:
  - ../../
  - namespace.yaml
  - secrets.yaml

# Development-specific patches
patches:
  # Reduce PostgreSQL to single replica for dev
  - target:
      kind: StatefulSet
      name: postgres
    patch: |
      - op: replace
        path: /spec/replicas
        value: 1
      - op: replace
        path: /spec/template/spec/affinity/podAntiAffinity/requiredDuringSchedulingIgnoredDuringExecution
        value: []
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "250m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "512Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "1000m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "2Gi"

  # Reduce etcd to single replica for dev
  - target:
      kind: StatefulSet
      name: etcd
    patch: |
      - op: replace
        path: /spec/replicas
        value: 1
      - op: replace
        path: /spec/template/spec/affinity/podAntiAffinity/requiredDuringSchedulingIgnoredDuringExecution
        value: []

  # Reduce Redis to single instance (no sentinel needed)
  - target:
      kind: StatefulSet
      name: redis-master
    patch: |
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "50m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "128Mi"

  # Disable Redis Sentinel in dev
  - target:
      kind: StatefulSet
      name: redis-sentinel
    patch: |
      - op: replace
        path: /spec/replicas
        value: 0

  # Reduce Kafka to single broker for dev
  - target:
      kind: StatefulSet
      name: kafka
    patch: |
      - op: replace
        path: /spec/replicas
        value: 1
      - op: replace
        path: /spec/template/spec/affinity/podAntiAffinity/requiredDuringSchedulingIgnoredDuringExecution
        value: []
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "250m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "512Mi"

  # Single GRC Portal replica for dev
  - target:
      kind: Deployment
      name: grc-portal
    patch: |
      - op: replace
        path: /spec/replicas
        value: 1
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "100m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "256Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "1000m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "1Gi"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: ASPNETCORE_ENVIRONMENT
          value: "Development"

  # Disable HPA in dev
  - target:
      kind: HorizontalPodAutoscaler
      name: grc-portal-hpa
    patch: |
      - op: replace
        path: /spec/minReplicas
        value: 1
      - op: replace
        path: /spec/maxReplicas
        value: 1

  # Disable PDBs in dev (single replicas don't need them)
  - target:
      kind: PodDisruptionBudget
      name: .*
    patch: |
      - op: replace
        path: /spec/minAvailable
        value: 0

  # Disable network policies in dev for easier debugging
  - target:
      kind: NetworkPolicy
      name: default-deny-ingress
    patch: |
      $patch: delete

# ConfigMap overrides for dev
configMapGenerator:
  - name: dev-config
    literals:
      - LOG_LEVEL=Debug
      - ENABLE_SWAGGER=true
      - ENABLE_DETAILED_ERRORS=true

# Smaller storage for dev
replicas:
  - name: redis-replica
    count: 0
